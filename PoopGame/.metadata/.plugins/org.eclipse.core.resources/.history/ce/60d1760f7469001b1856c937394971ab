package poopgame.gamelogic.systems;

import com.badlogic.ashley.core.Engine;
import com.badlogic.ashley.core.Entity;
import com.badlogic.ashley.core.EntitySystem;
import com.badlogic.ashley.core.Family;
import com.badlogic.ashley.utils.ImmutableArray;

import poopgame.gamelogic.components.UpdateComponent;
import poopgame.gamelogic.engine.LogicSystem;
import poopgame.graphics.components.TransformComponent;
import poopgame.physics.components.BodyComponent;

public class UpdateSystem extends EntitySystem implements LogicSystem {

    private static final float STEP_TIME = 1/45f;

	private ImmutableArray<Entity> updateableEntites;

    private float accumulator = 0f;

	@Override
	public void addedToEngine (Engine engine) {
		updateableEntites = engine.getEntitiesFor(Family.all(UpdateComponent.class).get());
	}

	@Override
	public void removedFromEngine (Engine engine) {
		updateableEntites = null;
	}

    @Override
    public void update(float deltaTime) {
        super.update(deltaTime);
        float frameTime = Math.min(deltaTime, 0.25f);
        accumulator += frameTime;
        while (accumulator >= STEP_TIME) {
        	step();
        }
    }
    
    private void step() {
    	for (Entity entity : updateableEntites) {
    		entity.getComponent(UpdateComponent.class).updateable.update(STEP_TIME);
    	}
    }

	@Override
	public Object storeState() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public void loadState(Object state) {
		// TODO Auto-generated method stub
		
	}

}
