package poopgame.ui;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.util.Random;

import javax.swing.BorderFactory;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.border.Border;
import javax.swing.border.EtchedBorder;

import org.kordamp.ikonli.fontawesome5.FontAwesomeSolid;

import com.badlogic.gdx.Gdx;

import graphics.swing.Borders;
import graphics.swing.JImage;
import graphics.swing.SelectionPanel.SelectionDialog;
import net.miginfocom.swing.MigLayout;
import poopgame.gamelogic.Arena;
import poopgame.gamelogic.Champion;
import poopgame.gamelogic.PoopGame;
import poopgame.gamelogic.components.PlayerComponent;
import poopgame.server.GameServer;
import poopgame.server.LocalServer;
import poopgame.server.RemoteServer;
import util.ColorUtil;

public class Lobby extends MenuPanel {
	private static final long serialVersionUID = 1L;

	private static final Random RANDOM = new Random();
	
	private GameServer server;
	private PlayerComponent activePlayer;
	
	private JLabel arenaNameLabel;
	private JImage arenaImage;
	
	private JPanel playerList;
	
	public Lobby(String host, String name, Champion champion) throws Exception  {
		
	}
	
	private static Server initServer(String host, Player player) {
		
	}

	public Lobby(String host, String name, Champion champion) throws Exception  {
		super("wrap 2, fill, insets 50", "[grow]50px[right]", "");
		
		activePlayer = new PlayerComponent(RANDOM.nextLong(), name, champion);
		if (host == null) {
			server = new LocalServer();
		} else {
			server = new RemoteServer(host);
		}
		
		arenaNameLabel = new JLabel(server.getArena().getName());
		arenaNameLabel.setFont(arenaNameLabel.getFont().deriveFont(100f));
		add(arenaNameLabel);
		arenaImage = new JImage(server.getArena().getIcon());
		arenaImage.setFont(arenaImage.getFont().deriveFont(100f));
		if (host == null) arenaImage.addActionListener(e -> changeArena());
		add(arenaImage);
		
		playerList = new JPanel(new MigLayout("wrap 3, fill, insets 50", "[]20px[grow, fill]20px[]", ""));
		playerList.setOpaque(false);
		add(playerList, "span 2, grow");
		
		MenuButton exitButton = new MenuButton("EXIT");
		exitButton.addActionListener(e -> showMainMenu());
		add(exitButton);
		MenuButton startButton = new MenuButton(host == null ? "START" : "WAITING FOR HOST");
		startButton.setEnabled(host == null);
		startButton.addActionListener(e -> start());
		add(startButton);
		
		server.addLobbyUpdateListener(() -> updateLobby());
		
		if (server instanceof RemoteServer) {
			((RemoteServer) server).addStartListener(() -> start());
		}

		server.addPlayer(activePlayer);
	}
	
	private void updateLobby() {
		playerList.removeAll();
		for (PlayerComponent player : server.getPlayers()) {
			playerList.add(new JImage(player.champ.getIcon()));
			playerList.add(new JLabel(player.name));
			JImage kickButton = new JImage(FontAwesomeSolid.TIMES, ColorUtil.ERROR_FOREGROUND_COLOR);
			kickButton.setEnabled((server instanceof LocalServer) && player.id != activePlayer.id);
			playerList.add(kickButton);
		}
		playerList.revalidate();
		playerList.repaint();

		arenaNameLabel.setText(server.getArena().getName());
		arenaImage.setImage(server.getArena().getIcon());
	}
	
	private void changeArena() {
		if (server instanceof LocalServer) {
			LocalServer localServer = (LocalServer) server;
			Arena newArena = new ArenaSelectionDialg().open();
			if (newArena != null) {
				localServer.setArena(newArena);
			}
		}
	}

	private void showMainMenu() {
		server.dispose();
		SwingFrame.goTo(new MainMenu());
	}

	private void start() {
		if (server instanceof LocalServer) {
			((LocalServer) server).startLobby();
		}

		SwingFrame.showGame();
		Gdx.app.postRunnable(() -> {
			PoopGame.getInstance().setServer(server);
			PoopGame.getInstance().setActivePlayerId(activePlayer.id);
		});
	}
	
	private class ArenaSelectionDialg extends SelectionDialog<Arena> {
		private static final long serialVersionUID = 1L;

		public ArenaSelectionDialg() {
			super(arenaImage, true, Arena.values());
			selectionPanel.contentContainer.setBackground(new Color(93, 105, 73));
			selectionPanel.remove(selectionPanel.searchField);
		}

		@Override
		public Component createComponent(Arena element) {
			JPanel arenaPanel = new JPanel(new BorderLayout());
			arenaPanel.setOpaque(false);
			arenaPanel.add(new JImage(element.getIcon()), BorderLayout.CENTER);
			arenaPanel.add(new JLabel(element.getName()), BorderLayout.SOUTH);
			Border hoveredBorder = BorderFactory.createEtchedBorder(EtchedBorder.RAISED, SwingFrame.FOREGROUND, SwingFrame.FOREGROUND.darker().darker());
			Border clickedBorder = BorderFactory.createEtchedBorder(EtchedBorder.LOWERED, SwingFrame.FOREGROUND, SwingFrame.FOREGROUND.darker().darker());
			Borders.set(arenaPanel, null, hoveredBorder, clickedBorder);
			return arenaPanel;
		}

		@Override
		public boolean matchesFilter(Arena element, String filter) {
			return element.getName().toLowerCase().contains(filter.toLowerCase());
		}
		
	}

}
