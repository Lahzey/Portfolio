package poopgame.server;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.creditsuisse.util.GeneralListener;
import com.esotericsoftware.kryonet.Client;
import com.esotericsoftware.kryonet.Connection;
import com.esotericsoftware.kryonet.Listener;

import poopgame.gamelogic.Arena;
import poopgame.gamelogic.Player;
import poopgame.gamelogic.PoopGame;
import poopgame.gamelogic.engine.TimeEngine;
import poopgame.gamelogic.engine.actions.Action;

public class RemoteServer extends Listener implements GameServer {
	
	private Client client = new Client();
	private Player activePlayer = null;

	private Arena arena = Arena.SEWER;
	private Map<Long, Player> playerMap = new HashMap<Long, Player>();
	private List<Player> players = new ArrayList<>(); // just to keep the players the order they joined in
	
	private long startTime = 0;
	
	private List<GeneralListener> lobbyUpdateListeners = new ArrayList<>();
	private List<GeneralListener> startListeners = new ArrayList<>();
	private List<ActionReceiver> actionReceivers = new ArrayList<>();

	private TimeEngine engine;
	
	private Map<Long, Long> sendTimes = new HashMap<>();;
	private long lastDelay = 0;
	
	public RemoteServer(String host) throws Exception {
		client.start();
		client.connect(60000, host, TCP_PORT, UDP_PORT);
		client.addListener(this);
	    RequestRegister.registerAll(client.getKryo());
	}
	
	@Override
	public void setEngine(TimeEngine engine) {
		this.engine = engine;
	}
	
	@Override
	public Arena getArena() {
		return arena;
	}

	@Override
	public Player[] getPlayers() {
		return players.toArray(new Player[players.size()]);
	}

	@Override
	public long getStartTime() {
		return startTime;
	}

	@Override
	public void dispatchAction(ActionRequest actionRequest) {
		client.sendUDP(actionRequest);
	}

	@Override
	public long estimateDelay() {
		return 0;
	}

	@Override
	public void addReceiver(ActionReceiver receiver) {
		actionReceivers.add(receiver);
	}

	@Override
	public void dispose() {
		client.stop();
	}

	@Override
	public void addPlayer(Player player) {
		if (activePlayer == null) {
			activePlayer = player;
			players.add(player);
			playerMap.put(player.getPlayerId(), player);
			client.sendTCP(new JoinRequest(player.getPlayerId(), player.getName(), player.getChampion()));
		} else {
			throw new RuntimeException("Only one player per client.");
		}
	}
	
	@Override
	public void received(Connection connection, Object object) {
		if (object instanceof LobbyUpdate) {
			LobbyUpdate lobbyUpdate = (LobbyUpdate) object;
			
			players.clear();
			for (JoinRequest joinedPlayer : lobbyUpdate.joinedPlayers) {
				Player player;
				if (playerMap.containsKey(joinedPlayer.playerId)) {
					player = playerMap.get(joinedPlayer.playerId);
					player.setName(joinedPlayer.name);
					player.setChampion(joinedPlayer.champ);
				} else {
					player = new Player(joinedPlayer.playerId, joinedPlayer.name, joinedPlayer.champ);
					playerMap.put(player.getPlayerId(), player);
				}
				players.add(player);
			}
			
			arena = lobbyUpdate.arena;

			for (GeneralListener lobbyUpdateListener : lobbyUpdateListeners) {
				lobbyUpdateListener.actionPerformed();
			}
		} else if (object instanceof StartSignal) {
			StartSignal startSignal = (StartSignal) object;
			startTime = startSignal.startTime;
			
			for (GeneralListener startListener : startListeners) {
				startListener.actionPerformed();
			}
		} else if (object instanceof ActionRequest) {
			ActionRequest actionRequest = (ActionRequest) object;
			Action action = new Action(actionRequest.actionId, actionRequest.actionType, playerMap.get(actionRequest.playerId), actionRequest.actionTime);
			
			PoopGame.getInstance().executeAfterNextUpdate(() -> {
				for (ActionReceiver actionReceiver : actionReceivers) {
					actionReceiver.receive(action);
				}
			});
		} else if (object instanceof StateUpdate) {
			if (engine != null) {
				engine.applyStateUpdate((StateUpdate) object);
			}
		}
	}

	@Override
	public void addLobbyUpdateListener(GeneralListener updateListener) {
		lobbyUpdateListeners.add(updateListener);
	}

	public void addStartListener(GeneralListener startListener) {
		startListeners.add(startListener);
	}

}
